
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" content="text/html;charset=UTF-8" http-equiv="Content-Type">
    <title>查看沟通纪要记录中...</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!--基础js-->
    <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <script src="http://crm.younengkao.com/assets/js/jquery-3.2.1.min.js"></script>
</head>
<body>
    <div></div>
    <script type="text/javascript">
        //此页面是菜单二级页面
        $(function () {
            redirectToAuthPage();
        })
        function redirectToAuthPage() {
            var link = location.href;
            $.ajax({
                url:"http://crm.younengkao.com/WeiChat/getSignature",//获取api签名
                type: "post",
                data:{url:link.split('#')[0]},
                contentType: 'application/x-www-form-urlencoded',
                dataType: "json",
                success: function (data) {
                    wx.config({
                        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来
                        appId: data.appId, // 必填，公众号的唯一标识
                        timestamp: data.timestamp, // 必填，生成签名的时间戳
                        nonceStr: data.noncestr, // 必填，生成签名的随机串
                        signature: data.signature,// 必填，签名，见附录1
                        jsApiList: [
                            "openLocation"
                        ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                    });
                    wx.error(function (res) {

                    });
                    wx.ready(function () {
                        var appid = data.appId;
                        //把二级页面url编码生成新的连接并重定向二级菜单页面
                        const callbackURL = encodeURIComponent('http://crm.younengkao.com/Communicate/List')
                        const redirectURI = 'https://open.weixin.qq.com/connect/oauth2/authorize?' + 'appid=' + appid + '&redirect_uri=' + callbackURL+'&response_type=code&scope=snsapi_base&state=1#wechat_redirect';
                        location.replace(redirectURI);

                    });
                }
            });
        }
    </script>
</body>
</html>